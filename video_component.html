<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰øÆÁ∑¥ÈÅäÊà≤ - ÂΩ±ÁâáÂÖÉ‰ª∂</title>
    
    <!-- Twitch Extensions SDK -->
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: transparent;
            color: #efeff1;
            overflow: hidden;
            user-select: none;
            width: 600px;
            max-width: 600px;
            font-size: 18px;
        }

        /* ‰∏ªÂÆπÂô® */
        .game-panel {
            width: 100%;
            max-width: 580px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 15px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            position: relative;
        }

        .game-panel.minimized {
            height: 50px;
            overflow: hidden;
        }

        /* È†≠ÈÉ® */
        .panel-header {
            background: rgba(145, 70, 255, 0.9);
            padding: 12px 16px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .minimize-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: background 0.2s ease;
            font-weight: bold;
        }

        .minimize-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ÂÖßÂÆπÂçÄÂüü */
        .panel-content {
            padding: 20px;
        }

        /* Áé©ÂÆ∂ÁãÄÊÖãÂçÄÂüü */
        .player-section {
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.15);
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: 1.6rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .player-realm {
            font-size: 1.2rem;
            color: #b9a3e3;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .exp-bar {
            position: relative;
            width: 100%;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .exp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* ÊéíË°åÊ¶úÂçÄÂüü */
        .leaderboard-section {
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .leaderboard-rank {
            font-weight: 700;
            color: #ffd700;
            min-width: 28px;
            text-align: center;
            font-size: 1.2rem;
        }

        .leaderboard-info {
            flex: 1;
            margin-left: 8px;
        }

        .leaderboard-name {
            font-weight: 600;
            color: #efeff1;
        }

        .leaderboard-level {
            font-size: 0.9rem;
            color: #b9a3e3;
        }

        .leaderboard-exp {
            font-size: 0.9rem;
            color: #4caf50;
            font-weight: 600;
        }

        /* ÁãÄÊÖãÊåáÁ§∫Âô® */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        .status-dot.disconnected {
            background: #f44336;
        }

        .status-text {
            color: #b9a3e3;
        }

        /* ‰øÆÁ∑¥ÁµêÊûúÂΩàÁ™ó */
        .cultivation-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            scale: 0.8;
            transition: all 0.3s ease;
            pointer-events: none;
            min-width: 200px;
        }

        .cultivation-result.show {
            opacity: 1;
            scale: 1;
            pointer-events: auto;
        }

        .result-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            animation: pulse 1s ease-in-out infinite;
        }

        .result-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 6px;
        }

        .result-details {
            font-size: 1rem;
            color: #efeff1;
            white-space: pre-line;
            font-weight: 500;
        }

        /* ËºâÂÖ•ÁãÄÊÖã */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 999;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 8px;
        }

        .loading-text {
            font-size: 1rem;
            color: #b9a3e3;
            font-weight: 500;
        }

        /* ÂãïÁï´ */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ÈüøÊáâÂºè */
        @media (max-width: 350px) {
            body {
                width: 100%;
                max-width: 100%;
            }
            
            .game-panel {
                max-width: 100%;
            }
            
            .panel-content {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ‰∏ªË¶ÅÈÅäÊà≤Èù¢Êùø -->
    <div class="game-panel" id="gamePanel">
        <!-- Èù¢ÊùøÈ†≠ÈÉ® -->
        <div class="panel-header">
            <div class="panel-title">
                üéÆ ‰øÆÁ∑¥ÈÅäÊà≤
            </div>
            <button class="minimize-btn" id="minimizeBtn" title="ÊúÄÂ∞èÂåñ/Â±ïÈñã">
                ‚îÄ
            </button>
        </div>

        <!-- Èù¢ÊùøÂÖßÂÆπ -->
        <div class="panel-content" id="panelContent">
            <!-- Áé©ÂÆ∂ÁãÄÊÖãÂçÄÂüü -->
            <div class="player-section">
                <div class="player-info">
                    <div class="player-name" id="playerName">ËºâÂÖ•‰∏≠...</div>
                    <div class="player-realm" id="playerRealm">ÁÖâÊ∞£Êúü Á¨¨1Â±§</div>
                    <div class="exp-bar">
                        <div class="exp-fill" id="expFill" style="width: 0%"></div>
                        <div class="exp-text" id="expText">0 / 100</div>
                    </div>
                </div>
            </div>

            <!-- ÊéíË°åÊ¶úÂçÄÂüü -->
            <div class="leaderboard-section">
                <div class="section-title">
                    üèÜ ÊéíË°åÊ¶ú Top 5
                </div>
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- ÊéíË°åÊ¶úÈ†ÖÁõÆÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>

            <!-- ÁãÄÊÖãÊåáÁ§∫Âô® -->
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span class="status-text" id="statusText">ÈÄ£Êé•‰∏≠...</span>
            </div>
        </div>

        <!-- ‰øÆÁ∑¥ÁµêÊûúÂΩàÁ™ó -->
        <div class="cultivation-result" id="cultivationResult">
            <div class="result-icon" id="resultIcon">‚ö°</div>
            <div class="result-text" id="resultText">‰øÆÁ∑¥ÊàêÂäüÔºÅ</div>
            <div class="result-details" id="resultDetails">Áç≤Âæó 50 Á∂ìÈ©ó</div>
        </div>

        <!-- ËºâÂÖ•Ë¶ÜËìãÂ±§ -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">ËºâÂÖ•ÈÅäÊà≤Êï∏Êìö...</div>
        </div>
    </div>

    <!-- JavaScript ÈÇèËºØ -->
    <script>
        class CultivationVideoComponent {
            constructor() {
                this.twitch = window.Twitch ? window.Twitch.ext : null;
                this.auth = null;
                this.context = null;
                this.playerData = null;
                this.leaderboardData = [];
                this.isConnected = false;
                this.isMinimized = false;
                
                // API Ë®≠ÂÆö
                this.apiBaseUrl = 'http://172.25.241.201:3000/api';
                
                // Êõ¥Êñ∞ÈñìÈöî
                this.updateInterval = null;
                
                this.init();
            }

            init() {
                console.log('ÂàùÂßãÂåñ‰øÆÁ∑¥ÈÅäÊà≤ÂΩ±ÁâáÂÖÉ‰ª∂...');
                
                if (this.twitch) {
                    this.setupTwitchCallbacks();
                } else {
                    console.log('ÈñãÁôºÊ®°ÂºèÔºöÊú™Ê™¢Ê∏¨Âà∞ Twitch Extensions SDK');
                    this.initDevelopmentMode();
                }
                
                this.setupEventListeners();
                this.startUpdateCycle();
            }

            setupTwitchCallbacks() {
                this.twitch.onAuthorized((auth) => {
                    console.log('Áî®Êà∂Â∑≤ÊéàÊ¨ä:', auth);
                    this.auth = auth;
                    this.loadPlayerData();
                });

                this.twitch.onContext((context, delta) => {
                    this.context = context;
                    this.handleContextChange(context);
                });

                this.twitch.onVisibilityChanged((isVisible) => {
                    if (isVisible) {
                        this.refreshData();
                    }
                });

                this.twitch.listen('broadcast', (target, contentType, message) => {
                    this.handleBroadcastMessage(message);
                });
            }

            initDevelopmentMode() {
                this.auth = {
                    token: 'dev-token',
                    userId: 'dev-user-123',
                    channelId: 'dev-channel-456'
                };
                
                setTimeout(() => {
                    this.loadPlayerData();
                }, 1000);
            }

            setupEventListeners() {
                // ÊúÄÂ∞èÂåñÊåâÈàï
                document.getElementById('minimizeBtn').addEventListener('click', () => {
                    this.toggleMinimize();
                });
            }

            async loadPlayerData() {
                try {
                    this.showLoading();
                    const username = this.getUsernameFromAuth();
                    
                    if (!username) {
                        console.log('ÁÑ°Ê≥ïÁç≤ÂèñÁî®Êà∂ÂêçÁ®±');
                        this.setConnectionStatus(false);
                        this.hideLoading();
                        return;
                    }

                    const response = await this.apiRequest(`/players/${username}`);
                    
                    if (response.success) {
                        this.playerData = response.data;
                        this.updatePlayerUI();
                        this.setConnectionStatus(true);
                        this.loadLeaderboard();
                    } else {
                        console.error('ËºâÂÖ•Áé©ÂÆ∂Êï∏ÊìöÂ§±Êïó:', response.message);
                        this.setConnectionStatus(false);
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('ËºâÂÖ•Áé©ÂÆ∂Êï∏ÊìöÈåØË™§:', error);
                    this.setConnectionStatus(false);
                    this.hideLoading();
                }
            }

            async loadLeaderboard() {
                try {
                    const response = await this.apiRequest('/leaderboard?limit=5');
                    
                    if (response.success) {
                        this.leaderboardData = response.data;
                        this.updateLeaderboardUI();
                    } else {
                        console.error('ËºâÂÖ•ÊéíË°åÊ¶úÂ§±Êïó:', response.message);
                    }
                } catch (error) {
                    console.error('ËºâÂÖ•ÊéíË°åÊ¶úÈåØË™§:', error);
                }
            }

            updatePlayerUI() {
                if (!this.playerData) return;

                const playerName = document.getElementById('playerName');
                const playerRealm = document.getElementById('playerRealm');
                const expFill = document.getElementById('expFill');
                const expText = document.getElementById('expText');

                if (playerName) {
                    playerName.textContent = this.playerData.username;
                }

                if (playerRealm) {
                    playerRealm.textContent = `${this.playerData.realm} Á¨¨${this.playerData.level}Â±§`;
                }

                if (expFill && expText) {
                    const expProgress = (this.playerData.experience / this.playerData.expRequired) * 100;
                    expFill.style.width = `${Math.min(expProgress, 100)}%`;
                    expText.textContent = `${this.playerData.experience} / ${this.playerData.expRequired}`;
                }
            }

            updateLeaderboardUI() {
                const leaderboardList = document.getElementById('leaderboardList');
                if (!leaderboardList) return;

                leaderboardList.innerHTML = '';

                if (this.leaderboardData.length === 0) {
                    leaderboardList.innerHTML = '<div style="text-align: center; color: #666; font-size: 0.8rem; padding: 10px;">Êö´ÁÑ°ÊéíË°åÊ¶úÊï∏Êìö</div>';
                    return;
                }

                this.leaderboardData.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <div class="leaderboard-rank">${index + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${player.username}</div>
                            <div class="leaderboard-level">${player.realm} ${player.level}Â±§</div>
                        </div>
                        <div class="leaderboard-exp">${this.formatNumber(player.totalExperience)}</div>
                    `;
                    leaderboardList.appendChild(item);
                });
            }

            showCultivationResult(result) {
                const resultElement = document.getElementById('cultivationResult');
                const resultIcon = document.getElementById('resultIcon');
                const resultText = document.getElementById('resultText');
                const resultDetails = document.getElementById('resultDetails');

                if (result.success) {
                    resultIcon.textContent = result.critical ? 'üí•' : '‚ö°';
                    resultText.textContent = '‰øÆÁ∑¥ÊàêÂäüÔºÅ';
                    resultDetails.textContent = `Áç≤Âæó ${result.experience} Á∂ìÈ©ó`;
                    
                    if (result.levelUp) {
                        resultDetails.textContent += `\nüéâ ÂçáÁ¥öÂà∞ ${result.levelUp.realm} ${result.levelUp.level}Â±§ÔºÅ`;
                    }
                } else {
                    resultIcon.textContent = 'üíî';
                    resultText.textContent = '‰øÆÁ∑¥Â§±Êïó';
                    resultDetails.textContent = result.message || '‰øÆÁ∑¥Â§±ÊïóÔºåË´ãÈáçË©¶';
                }

                resultElement.classList.add('show');
                
                setTimeout(() => {
                    resultElement.classList.remove('show');
                }, 3000);
            }

            handleBroadcastMessage(message) {
                try {
                    const data = JSON.parse(message);
                    
                    switch (data.type) {
                        case 'cultivation_result':
                            this.showCultivationResult(data.payload);
                            break;
                        case 'player_update':
                            this.playerData = data.payload;
                            this.updatePlayerUI();
                            break;
                        case 'leaderboard_update':
                            this.leaderboardData = data.payload;
                            this.updateLeaderboardUI();
                            break;
                        default:
                            console.log('Êú™Áü•ÁöÑÂª£Êí≠Ë®äÊÅØÈ°ûÂûã:', data.type);
                    }
                } catch (error) {
                    console.error('ËôïÁêÜÂª£Êí≠Ë®äÊÅØÈåØË™§:', error);
                }
            }

            toggleMinimize() {
                const gamePanel = document.getElementById('gamePanel');
                const minimizeBtn = document.getElementById('minimizeBtn');
                
                this.isMinimized = !this.isMinimized;
                
                if (this.isMinimized) {
                    gamePanel.classList.add('minimized');
                    minimizeBtn.textContent = '+';
                } else {
                    gamePanel.classList.remove('minimized');
                    minimizeBtn.textContent = '‚îÄ';
                }
            }

            setConnectionStatus(connected) {
                this.isConnected = connected;
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Â∑≤ÈÄ£Êé•';
                } else {
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'ÈÄ£Êé•Â§±Êïó';
                }
            }

            showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }

            refreshData() {
                console.log('Âà∑Êñ∞Êï∏Êìö...');
                this.loadPlayerData();
            }

            startUpdateCycle() {
                // ÊØè10ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Êï∏Êìö
                this.updateInterval = setInterval(() => {
                    if (this.isConnected && !this.isMinimized) {
                        this.refreshData();
                    }
                }, 10000);
            }

            stopUpdateCycle() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }

            async apiRequest(endpoint, options = {}) {
                const url = `${this.apiBaseUrl}${endpoint}`;
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.auth ? this.auth.token : ''}`
                    },
                    timeout: 8000
                };

                try {
                    const response = await fetch(url, { ...defaultOptions, ...options });
                    return await response.json();
                } catch (error) {
                    console.error('API Ë´ãÊ±ÇÂ§±Êïó:', error);
                    return { success: false, message: error.message };
                }
            }

            getUsernameFromAuth() {
                if (this.auth && this.auth.userId) {
                    return this.auth.userId;
                }
                return 'feisheng123'; // ÈñãÁôºÊ®°ÂºèÈªòË™çÁî®Êà∂
            }

            formatNumber(num) {
                if (typeof num !== 'number') return '0';
                
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }

            // Ê∏ÖÁêÜË≥áÊ∫ê
            destroy() {
                this.stopUpdateCycle();
                
                if (this.twitch) {
                    this.twitch.unlisten('broadcast', () => {});
                }
                
                console.log('ÂΩ±ÁâáÂÖÉ‰ª∂Â∑≤Èä∑ÊØÄ');
            }
        }

        // Áï∂È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÊôÇÂàùÂßãÂåñÂÖÉ‰ª∂
        document.addEventListener('DOMContentLoaded', () => {
            window.cultivationVideoComponent = new CultivationVideoComponent();
        });

        // Áï∂È†ÅÈù¢Âç≥Â∞áÈóúÈñâÊôÇÊ∏ÖÁêÜË≥áÊ∫ê
        window.addEventListener('beforeunload', () => {
            if (window.cultivationVideoComponent) {
                window.cultivationVideoComponent.destroy();
            }
        });
    </script>
</body>
</html>