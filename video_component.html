<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修練遊戲 - 影片元件</title>
    
    <!-- Twitch Extensions SDK -->
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: transparent;
            color: #efeff1;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            font-size: clamp(14px, 2vw, 24px);
        }

        /* 主容器 */
        .game-panel {
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            border: none;
            box-shadow: none;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .game-panel.minimized {
            height: clamp(50px, 8vh, 80px);
            overflow: hidden;
        }

        /* 頭部 */
        .panel-header {
            background: rgba(145, 70, 255, 0.9);
            padding: clamp(15px, 3vh, 25px) clamp(20px, 4vw, 40px);
            border-radius: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: clamp(1.5rem, 4vw, 3rem);
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: clamp(8px, 1vw, 16px);
        }

        .minimize-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: clamp(1.2rem, 3vw, 2rem);
            cursor: pointer;
            padding: clamp(6px, 1vh, 12px) clamp(8px, 1vw, 16px);
            border-radius: 6px;
            transition: background 0.2s ease;
            font-weight: bold;
        }

        .minimize-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 內容區域 */
        .panel-content {
            padding: clamp(20px, 4vw, 50px);
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 3vh, 40px);
        }

        /* 玩家狀態區域 */
        .player-section {
            padding-bottom: clamp(15px, 3vh, 30px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.15);
            flex-shrink: 0;
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: clamp(1.8rem, 5vw, 4rem);
            font-weight: 700;
            color: #ffd700;
            margin-bottom: clamp(8px, 2vh, 16px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .player-realm {
            font-size: clamp(1.2rem, 3vw, 2.5rem);
            color: #b9a3e3;
            margin-bottom: clamp(15px, 3vh, 25px);
            font-weight: 600;
        }

        .exp-bar {
            position: relative;
            width: 100%;
            height: clamp(25px, 4vh, 50px);
            background: rgba(255, 255, 255, 0.2);
            border-radius: clamp(10px, 2vh, 25px);
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .exp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(1rem, 2.5vw, 2rem);
            font-weight: 700;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* 遊戲數值區域 */
        .stats-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .section-title {
            font-size: clamp(1.4rem, 4vw, 3rem);
            font-weight: 700;
            color: #ffd700;
            margin-bottom: clamp(12px, 2vh, 20px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 1vw, 16px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            flex-shrink: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(clamp(120px, 20vw, 200px), 1fr));
            gap: clamp(10px, 2vh, 20px);
            flex: 1;
            overflow-y: auto;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(12px, 2vh, 20px);
            background: rgba(255, 255, 255, 0.08);
            border-radius: clamp(8px, 1vh, 15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s ease;
            min-height: clamp(60px, 8vh, 100px);
            text-align: center;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: clamp(0.7rem, 1.5vw, 1.1rem);
            color: #b9a3e3;
            margin-bottom: clamp(4px, 0.5vh, 8px);
            font-weight: 500;
            white-space: nowrap;
        }

        .stat-value {
            font-size: clamp(1rem, 2.5vw, 1.8rem);
            font-weight: 700;
            color: #ffd700;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        /* 不同類型數值的顏色 */
        .stat-item:nth-child(1) .stat-value { color: #4caf50; }  /* 修練次數 - 綠色 */
        .stat-item:nth-child(2) .stat-value { color: #ffd700; }  /* 總經驗 - 金色 */
        .stat-item:nth-child(3) .stat-value { color: #ff6b35; }  /* 突破次數 - 橘色 */
        .stat-item:nth-child(4) .stat-value { color: #00bcd4; }  /* 效率 - 青色 */
        .stat-item:nth-child(5) .stat-value { color: #9c27b0; }  /* 時間 - 紫色 */
        .stat-item:nth-child(6) .stat-value { color: #e91e63; }  /* 境界 - 粉色 */

        /* 狀態指示器 */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: clamp(6px, 1vw, 12px);
            padding: clamp(8px, 1vh, 15px) clamp(10px, 2vw, 20px);
            background: rgba(255, 255, 255, 0.05);
            border-radius: clamp(6px, 1vh, 12px);
            font-size: clamp(0.8rem, 2vw, 1.4rem);
            flex-shrink: 0;
        }

        .status-dot {
            width: clamp(8px, 1.5vw, 15px);
            height: clamp(8px, 1.5vw, 15px);
            border-radius: 50%;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        .status-dot.disconnected {
            background: #f44336;
        }

        .status-text {
            color: #b9a3e3;
        }

        /* 修練結果彈窗 */
        .cultivation-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: clamp(8px, 1vh, 15px);
            padding: clamp(20px, 4vw, 40px);
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            scale: 0.8;
            transition: all 0.3s ease;
            pointer-events: none;
            min-width: clamp(200px, 30vw, 400px);
            max-width: 80vw;
        }

        .cultivation-result.show {
            opacity: 1;
            scale: 1;
            pointer-events: auto;
        }

        .result-icon {
            font-size: clamp(2rem, 6vw, 4rem);
            margin-bottom: clamp(8px, 2vh, 15px);
            animation: pulse 1s ease-in-out infinite;
        }

        .result-text {
            font-size: clamp(1rem, 3vw, 2rem);
            font-weight: 700;
            color: #ffd700;
            margin-bottom: clamp(6px, 1vh, 12px);
        }

        .result-details {
            font-size: clamp(0.9rem, 2.5vw, 1.5rem);
            color: #efeff1;
            white-space: pre-line;
            font-weight: 500;
        }

        /* 載入狀態 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            z-index: 999;
        }

        .spinner {
            width: clamp(24px, 4vw, 50px);
            height: clamp(24px, 4vw, 50px);
            border: clamp(2px, 0.5vw, 4px) solid rgba(255, 255, 255, 0.3);
            border-top: clamp(2px, 0.5vw, 4px) solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: clamp(8px, 2vh, 15px);
        }

        .loading-text {
            font-size: clamp(0.9rem, 2.5vw, 1.5rem);
            color: #b9a3e3;
            font-weight: 500;
        }

        /* 動畫 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 響應式優化 */
        @media (max-width: 768px) {
            .panel-content {
                gap: clamp(15px, 2vh, 25px);
            }
            
            .leaderboard-item {
                min-height: clamp(40px, 5vh, 60px);
            }
        }
        
        @media (max-height: 600px) {
            .panel-content {
                gap: clamp(10px, 1vh, 20px);
            }
            
            .player-section {
                padding-bottom: clamp(10px, 2vh, 20px);
            }
        }
    </style>
</head>
<body>
    <!-- 主要遊戲面板 -->
    <div class="game-panel" id="gamePanel">
        <!-- 面板頭部 -->
        <div class="panel-header">
            <div class="panel-title">
                🎮 修練遊戲
            </div>
            <button class="minimize-btn" id="minimizeBtn" title="最小化/展開">
                ─
            </button>
        </div>

        <!-- 面板內容 -->
        <div class="panel-content" id="panelContent">
            <!-- 玩家狀態區域 -->
            <div class="player-section">
                <div class="player-info">
                    <div class="player-name" id="playerName">載入中...</div>
                    <div class="player-realm" id="playerRealm">煉氣期 第1層</div>
                    <div class="exp-bar">
                        <div class="exp-fill" id="expFill" style="width: 0%"></div>
                        <div class="exp-text" id="expText">0 / 100</div>
                    </div>
                </div>
            </div>

            <!-- 遊戲數值區域 -->
            <div class="stats-section">
                <div class="section-title">
                    📊 遊戲數值
                </div>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-item">
                        <div class="stat-label">修練次數</div>
                        <div class="stat-value" id="cultivationCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">總經驗值</div>
                        <div class="stat-value" id="totalExperience">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">突破次數</div>
                        <div class="stat-value" id="breakthroughCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">修練效率</div>
                        <div class="stat-value" id="efficiency">100%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">在線時間</div>
                        <div class="stat-value" id="onlineTime">0分鐘</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">當前境界</div>
                        <div class="stat-value" id="currentRealm">煉氣期</div>
                    </div>
                </div>
            </div>

            <!-- 狀態指示器 -->
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span class="status-text" id="statusText">連接中...</span>
            </div>
        </div>

        <!-- 修練結果彈窗 -->
        <div class="cultivation-result" id="cultivationResult">
            <div class="result-icon" id="resultIcon">⚡</div>
            <div class="result-text" id="resultText">修練成功！</div>
            <div class="result-details" id="resultDetails">獲得 50 經驗</div>
        </div>

        <!-- 載入覆蓋層 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">載入遊戲數據...</div>
        </div>
    </div>

    <!-- JavaScript 邏輯 -->
    <script>
        class CultivationVideoComponent {
            constructor() {
                this.twitch = window.Twitch ? window.Twitch.ext : null;
                this.auth = null;
                this.context = null;
                this.playerData = null;
                this.playerStats = null;
                this.isConnected = false;
                this.isMinimized = false;
                
                // API 設定
                this.apiBaseUrl = 'http://172.25.241.201:3000/api';
                this.useDatabase = true; // 是否使用數據庫
                
                // 更新間隔
                this.updateInterval = null;
                
                this.init();
            }

            init() {
                console.log('初始化修練遊戲影片元件...');
                
                if (this.twitch) {
                    this.setupTwitchCallbacks();
                } else {
                    console.log('開發模式：未檢測到 Twitch Extensions SDK');
                    this.initDevelopmentMode();
                }
                
                this.setupEventListeners();
                this.startUpdateCycle();
                this.startDatabaseSync();
            }

            setupTwitchCallbacks() {
                this.twitch.onAuthorized((auth) => {
                    console.log('用戶已授權:', auth);
                    this.auth = auth;
                    this.loadPlayerData();
                });

                this.twitch.onContext((context, delta) => {
                    this.context = context;
                    this.handleContextChange(context);
                });

                this.twitch.onVisibilityChanged((isVisible) => {
                    if (isVisible) {
                        this.refreshData();
                    }
                });

                this.twitch.listen('broadcast', (target, contentType, message) => {
                    this.handleBroadcastMessage(message);
                });
            }

            initDevelopmentMode() {
                // 生成基於瀏覽器的唯一用戶ID
                const userId = this.generateUniqueUserId();
                
                this.auth = {
                    token: 'dev-token',
                    userId: userId,
                    channelId: 'dev-channel-456'
                };
                
                // 設定個性化數據
                setTimeout(() => {
                    this.setPersonalizedData(userId);
                }, 1000);
            }
            
            generateUniqueUserId() {
                // 檢查是否已有儲存的用戶ID
                let userId = localStorage.getItem('cultivation_user_id');
                
                if (!userId) {
                    // 生成新的唯一ID
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('cultivation_user_id', userId);
                }
                
                return userId;
            }
            
            setPersonalizedData(userId) {
                // 基於用戶ID生成個性化數據
                const userData = this.generateUserData(userId);
                
                this.playerData = userData.playerData;
                this.playerStats = userData.playerStats;
                
                // 儲存到本地存儲
                this.saveUserData();
                
                this.updatePlayerUI();
                this.updateStatsUI();
                this.setConnectionStatus(true);
                this.hideLoading();
                
                // 添加實時數據更新模擬
                this.startMockDataUpdates();
            }
            
            generateUserData(userId) {
                // 使用用戶ID作為種子生成隨機數
                const seed = this.hashCode(userId);
                const random = this.seededRandom(seed);
                
                // 生成個性化用戶名
                const usernames = [
                    '飛升道友', '修真者', '煉丹師', '劍仙', '道長',
                    '仙友', '丹師', '劍客', '道士', '修士',
                    '天才', '奇才', '神童', '高手', '大師'
                ];
                const username = usernames[Math.floor(random() * usernames.length)] + Math.floor(random() * 9999);
                
                // 生成個性化境界
                const realms = ['煉氣期', '築基期', '金丹期', '元嬰期', '化神期'];
                const realmIndex = Math.floor(random() * realms.length);
                const realm = realms[realmIndex];
                const level = Math.floor(random() * 9) + 1;
                
                // 基於境界計算經驗值
                const baseExp = (realmIndex + 1) * 1000 + (level - 1) * 500;
                const experience = Math.floor(random() * 800) + 200;
                const expRequired = baseExp + Math.floor(random() * 500) + 500;
                
                // 生成個性化統計數據
                const cultivationCount = Math.floor(random() * 5000) + 1000;
                const totalExperience = Math.floor(random() * 100000) + 50000;
                const breakthroughCount = Math.floor(random() * 30) + 10;
                const efficiency = Math.floor(random() * 25) + 75;
                const onlineTime = Math.floor(random() * 500) + 100;
                
                return {
                    playerData: {
                        username: username,
                        realm: realm,
                        level: level,
                        experience: experience,
                        expRequired: expRequired
                    },
                    playerStats: {
                        cultivationCount: cultivationCount,
                        totalExperience: totalExperience,
                        breakthroughCount: breakthroughCount,
                        efficiency: efficiency,
                        onlineTime: onlineTime,
                        currentRealm: realm
                    }
                };
            }
            
            // 字符串哈希函數
            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // 轉換為32位整數
                }
                return Math.abs(hash);
            }
            
            // 基於種子的隨機數生成器
            seededRandom(seed) {
                let current = seed;
                return function() {
                    current = (current * 1103515245 + 12345) & 0x7fffffff;
                    return current / 0x7fffffff;
                };
            }
            
            // 儲存用戶數據到本地存儲
            saveUserData() {
                const userData = {
                    playerData: this.playerData,
                    playerStats: this.playerStats,
                    lastUpdate: Date.now()
                };
                localStorage.setItem('cultivation_user_data', JSON.stringify(userData));
            }
            
            // 從本地存儲載入用戶數據
            loadUserData() {
                const savedData = localStorage.getItem('cultivation_user_data');
                if (savedData) {
                    try {
                        const userData = JSON.parse(savedData);
                        
                        // 檢查數據是否過期（7天）
                        const now = Date.now();
                        const sevenDays = 7 * 24 * 60 * 60 * 1000;
                        
                        if (now - userData.lastUpdate < sevenDays) {
                            this.playerData = userData.playerData;
                            this.playerStats = userData.playerStats;
                            return true;
                        }
                    } catch (error) {
                        console.error('載入用戶數據失敗:', error);
                    }
                }
                return false;
            }
            
            setMockData() {
                // 嘗試載入已存儲的用戶數據
                if (this.loadUserData()) {
                    this.updatePlayerUI();
                    this.updateStatsUI();
                    this.setConnectionStatus(true);
                    this.hideLoading();
                    this.startMockDataUpdates();
                    return;
                }
                
                // 如果沒有儲存的數據，生成新的個性化數據
                const userId = this.generateUniqueUserId();
                this.setPersonalizedData(userId);
            }

            setupEventListeners() {
                // 最小化按鈕
                document.getElementById('minimizeBtn').addEventListener('click', () => {
                    this.toggleMinimize();
                });
            }

            async loadPlayerData() {
                try {
                    this.showLoading();
                    const username = this.getUsernameFromAuth();
                    
                    if (!username) {
                        console.log('無法獲取用戶名稱');
                        this.setConnectionStatus(false);
                        this.hideLoading();
                        return;
                    }

                    if (this.useDatabase) {
                        // 嘗試從 MongoDB 載入數據
                        const response = await this.apiRequest(`/players/${username}`);
                        
                        if (response.success) {
                            this.playerData = response.data;
                            this.updatePlayerUI();
                            this.setConnectionStatus(true);
                            this.loadPlayerStats();
                        } else {
                            console.log('從數據庫載入失敗，創建新玩家:', response.message);
                            // 創建新玩家
                            await this.createNewPlayer(username);
                        }
                    } else {
                        // 使用本地數據
                        this.setMockData();
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('載入玩家數據錯誤:', error);
                    console.log('切換到本地模式');
                    this.useDatabase = false;
                    this.setMockData();
                    this.hideLoading();
                }
            }

            async createNewPlayer(username) {
                try {
                    const newPlayerData = {
                        username: username,
                        realm: '煉氣期',
                        level: 1,
                        experience: 0,
                        expRequired: 100,
                        stats: {
                            cultivationCount: 0,
                            totalExperience: 0,
                            breakthroughCount: 0,
                            efficiency: 100,
                            onlineTime: 0,
                            currentRealm: '煉氣期'
                        }
                    };
                    
                    const response = await this.apiRequest('/players', {
                        method: 'POST',
                        body: JSON.stringify(newPlayerData)
                    });
                    
                    if (response.success) {
                        this.playerData = response.data;
                        this.playerStats = response.data.stats;
                        this.updatePlayerUI();
                        this.updateStatsUI();
                        this.setConnectionStatus(true);
                        console.log('新玩家創建成功');
                    } else {
                        throw new Error('創建新玩家失敗');
                    }
                } catch (error) {
                    console.error('創建新玩家錯誤:', error);
                    this.useDatabase = false;
                    this.setMockData();
                }
            }

            async loadPlayerStats() {
                if (!this.useDatabase) return;
                
                try {
                    const username = this.getUsernameFromAuth();
                    const response = await this.apiRequest(`/players/${username}/stats`);
                    
                    if (response.success) {
                        this.playerStats = response.data;
                        this.updateStatsUI();
                    } else {
                        console.error('載入遊戲數值失敗:', response.message);
                        this.setDefaultStats();
                    }
                } catch (error) {
                    console.error('載入遊戲數值錯誤:', error);
                    this.setDefaultStats();
                }
            }

            updatePlayerUI() {
                if (!this.playerData) return;

                const playerName = document.getElementById('playerName');
                const playerRealm = document.getElementById('playerRealm');
                const expFill = document.getElementById('expFill');
                const expText = document.getElementById('expText');

                if (playerName) {
                    playerName.textContent = this.playerData.username;
                }

                if (playerRealm) {
                    playerRealm.textContent = `${this.playerData.realm} 第${this.playerData.level}層`;
                }

                if (expFill && expText) {
                    const expProgress = (this.playerData.experience / this.playerData.expRequired) * 100;
                    expFill.style.width = `${Math.min(expProgress, 100)}%`;
                    expText.textContent = `${this.playerData.experience} / ${this.playerData.expRequired}`;
                }
            }

            updateStatsUI() {
                const stats = this.playerStats || this.getDefaultStats();
                
                // 更新各個數值
                this.updateStatValue('cultivationCount', stats.cultivationCount || 0);
                this.updateStatValue('totalExperience', this.formatNumber(stats.totalExperience || 0));
                this.updateStatValue('breakthroughCount', stats.breakthroughCount || 0);
                this.updateStatValue('efficiency', `${stats.efficiency || 100}%`);
                this.updateStatValue('onlineTime', this.formatTime(stats.onlineTime || 0));
                this.updateStatValue('currentRealm', stats.currentRealm || '煉氣期');
            }
            
            updateStatValue(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            }
            
            setDefaultStats() {
                this.playerStats = this.getDefaultStats();
                this.updateStatsUI();
            }
            
            getDefaultStats() {
                return {
                    cultivationCount: 0,
                    totalExperience: 0,
                    breakthroughCount: 0,
                    efficiency: 100,
                    onlineTime: 0,
                    currentRealm: '煉氣期'
                };
            }

            showCultivationResult(result) {
                const resultElement = document.getElementById('cultivationResult');
                const resultIcon = document.getElementById('resultIcon');
                const resultText = document.getElementById('resultText');
                const resultDetails = document.getElementById('resultDetails');

                if (result.success) {
                    resultIcon.textContent = result.critical ? '💥' : '⚡';
                    resultText.textContent = '修練成功！';
                    resultDetails.textContent = `獲得 ${result.experience} 經驗`;
                    
                    if (result.levelUp) {
                        resultDetails.textContent += `\n🎉 升級到 ${result.levelUp.realm} ${result.levelUp.level}層！`;
                    }
                } else {
                    resultIcon.textContent = '💔';
                    resultText.textContent = '修練失敗';
                    resultDetails.textContent = result.message || '修練失敗，請重試';
                }

                resultElement.classList.add('show');
                
                setTimeout(() => {
                    resultElement.classList.remove('show');
                }, 3000);
            }

            handleBroadcastMessage(message) {
                try {
                    const data = JSON.parse(message);
                    
                    switch (data.type) {
                        case 'cultivation_result':
                            this.showCultivationResult(data.payload);
                            break;
                        case 'player_update':
                            this.playerData = data.payload;
                            this.updatePlayerUI();
                            break;
                        case 'stats_update':
                            this.playerStats = data.payload;
                            this.updateStatsUI();
                            break;
                        default:
                            console.log('未知的廣播訊息類型:', data.type);
                    }
                } catch (error) {
                    console.error('處理廣播訊息錯誤:', error);
                }
            }

            toggleMinimize() {
                const gamePanel = document.getElementById('gamePanel');
                const minimizeBtn = document.getElementById('minimizeBtn');
                
                this.isMinimized = !this.isMinimized;
                
                if (this.isMinimized) {
                    gamePanel.classList.add('minimized');
                    minimizeBtn.textContent = '+';
                } else {
                    gamePanel.classList.remove('minimized');
                    minimizeBtn.textContent = '─';
                }
            }

            setConnectionStatus(connected) {
                this.isConnected = connected;
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = '已連接';
                } else {
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = '連接失敗';
                }
            }

            showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }

            refreshData() {
                console.log('刷新數據...');
                this.loadPlayerData();
            }

            startUpdateCycle() {
                // 每10秒更新一次數據
                this.updateInterval = setInterval(() => {
                    if (this.isConnected && !this.isMinimized) {
                        this.refreshData();
                    }
                }, 10000);
            }

            stopUpdateCycle() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }

            async apiRequest(endpoint, options = {}) {
                const url = `${this.apiBaseUrl}${endpoint}`;
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.auth ? this.auth.token : ''}`
                    },
                    timeout: 8000
                };

                try {
                    const response = await fetch(url, { ...defaultOptions, ...options });
                    return await response.json();
                } catch (error) {
                    console.error('API 請求失敗:', error);
                    return { success: false, message: error.message };
                }
            }

            getUsernameFromAuth() {
                if (this.auth && this.auth.userId) {
                    return this.auth.userId;
                }
                return 'feisheng123'; // 開發模式默認用戶
            }

            formatNumber(num) {
                if (typeof num !== 'number') return '0';
                
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }
            
            formatTime(minutes) {
                if (typeof minutes !== 'number') return '0分鐘';
                
                if (minutes >= 60) {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return `${hours}小時${mins}分鐘`;
                }
                return `${minutes}分鐘`;
            }

            // 模擬數據實時更新
            startMockDataUpdates() {
                // 每5秒模擬一次修練結果
                setInterval(() => {
                    if (Math.random() < 0.3) { // 30% 機率觸發修練結果
                        this.simulateCultivationResult();
                    }
                }, 5000);
                
                // 每3秒更新統計數據
                setInterval(() => {
                    this.updateMockStats();
                }, 3000);
            }
            
            simulateCultivationResult() {
                const results = [
                    { success: true, experience: 45, critical: false },
                    { success: true, experience: 65, critical: false },
                    { success: true, experience: 120, critical: true },
                    { success: true, experience: 85, critical: false },
                    { success: false, message: '修練失敗，心境不穩' }
                ];
                
                const result = results[Math.floor(Math.random() * results.length)];
                
                // 隨機升級事件
                if (result.success && Math.random() < 0.05) {
                    result.levelUp = {
                        realm: this.playerData.realm,
                        level: this.playerData.level + 1
                    };
                }
                
                this.showCultivationResult(result);
                
                // 更新玩家數據
                if (result.success) {
                    this.playerData.experience += result.experience;
                    this.playerStats.totalExperience += result.experience;
                    this.playerStats.cultivationCount++;
                    
                    // 檢查是否升級
                    if (this.playerData.experience >= this.playerData.expRequired) {
                        this.playerData.level++;
                        this.playerData.experience = 0;
                        this.playerData.expRequired = Math.floor(this.playerData.expRequired * 1.5);
                        this.playerStats.breakthroughCount++;
                        
                        // 境界突破
                        if (this.playerData.level > 9) {
                            this.advanceRealm();
                        }
                    }
                    
                    this.updatePlayerUI();
                    this.updateStatsUI();
                    
                    // 同步數據到數據庫
                    this.syncToDatabase();
                }
            }
            
            updateMockStats() {
                // 緩慢增加在線時間
                this.playerStats.onlineTime++;
                
                // 隨機調整效率
                const efficiencyChange = (Math.random() - 0.5) * 2;
                this.playerStats.efficiency = Math.max(75, Math.min(100, this.playerStats.efficiency + efficiencyChange));
                
                this.updateStatsUI();
                
                // 同步數據到數據庫
                this.syncToDatabase();
            }
            
            advanceRealm() {
                const realms = [
                    '煉氣期', '築基期', '金丹期', '元嬰期', '化神期', 
                    '練虛期', '合體期', '大乘期', '渡劫期', '大羅金仙'
                ];
                
                const currentIndex = realms.indexOf(this.playerData.realm);
                if (currentIndex >= 0 && currentIndex < realms.length - 1) {
                    this.playerData.realm = realms[currentIndex + 1];
                    this.playerData.level = 1;
                    this.playerStats.currentRealm = this.playerData.realm;
                    
                    // 顯示突破提示
                    this.showCultivationResult({
                        success: true,
                        experience: 0,
                        critical: true,
                        levelUp: {
                            realm: this.playerData.realm,
                            level: 1
                        }
                    });
                }
            }

            // 同步數據到數據庫
            async syncToDatabase() {
                if (!this.useDatabase || !this.playerData) return;
                
                try {
                    const username = this.getUsernameFromAuth();
                    const updateData = {
                        realm: this.playerData.realm,
                        level: this.playerData.level,
                        experience: this.playerData.experience,
                        expRequired: this.playerData.expRequired,
                        stats: this.playerStats
                    };
                    
                    const response = await this.apiRequest(`/players/${username}`, {
                        method: 'PUT',
                        body: JSON.stringify(updateData)
                    });
                    
                    if (response.success) {
                        console.log('數據已同步到數據庫');
                    } else {
                        console.error('同步數據失敗:', response.message);
                        // 失敗時保存到本地存儲作為備份
                        this.saveUserData();
                    }
                } catch (error) {
                    console.error('同步數據錯誤:', error);
                    // 失敗時保存到本地存儲作為備份
                    this.saveUserData();
                }
            }
            
            // 定期同步數據
            startDatabaseSync() {
                if (!this.useDatabase) return;
                
                // 每30秒同步一次數據
                setInterval(() => {
                    this.syncToDatabase();
                }, 30000);
            }
            
            // 從數據庫重新載入數據
            async refreshFromDatabase() {
                if (!this.useDatabase) return;
                
                try {
                    const username = this.getUsernameFromAuth();
                    const response = await this.apiRequest(`/players/${username}`);
                    
                    if (response.success) {
                        this.playerData = response.data;
                        this.playerStats = response.data.stats;
                        this.updatePlayerUI();
                        this.updateStatsUI();
                        console.log('數據已從數據庫重新載入');
                    }
                } catch (error) {
                    console.error('重新載入數據失敗:', error);
                }
            }

            // 清理資源
            destroy() {
                this.stopUpdateCycle();
                
                // 最後一次同步數據
                if (this.useDatabase) {
                    this.syncToDatabase();
                }
                
                if (this.twitch) {
                    this.twitch.unlisten('broadcast', () => {});
                }
                
                console.log('影片元件已銷毀');
            }
        }

        // 當頁面載入完成時初始化元件
        document.addEventListener('DOMContentLoaded', () => {
            window.cultivationVideoComponent = new CultivationVideoComponent();
        });

        // 當頁面即將關閉時清理資源
        window.addEventListener('beforeunload', () => {
            if (window.cultivationVideoComponent) {
                window.cultivationVideoComponent.destroy();
            }
        });
    </script>
</body>
</html>