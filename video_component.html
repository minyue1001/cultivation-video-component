<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ç·´éŠæˆ² - å½±ç‰‡å…ƒä»¶</title>
    
    <!-- Twitch Extensions SDK -->
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: transparent;
            color: #efeff1;
            overflow: hidden;
            user-select: none;
            width: 400px;
            max-width: 400px;
        }

        /* ä¸»å®¹å™¨ */
        .game-panel {
            width: 100%;
            max-width: 380px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .game-panel.minimized {
            height: 40px;
            overflow: hidden;
        }

        /* é ­éƒ¨ */
        .panel-header {
            background: rgba(145, 70, 255, 0.9);
            padding: 8px 12px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .minimize-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .minimize-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* å…§å®¹å€åŸŸ */
        .panel-content {
            padding: 12px;
        }

        /* ç©å®¶ç‹€æ…‹å€åŸŸ */
        .player-section {
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: 1rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 4px;
        }

        .player-realm {
            font-size: 0.85rem;
            color: #b9a3e3;
            margin-bottom: 8px;
        }

        .exp-bar {
            position: relative;
            width: 100%;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 8px;
            transition: width 0.5s ease;
            position: relative;
        }

        .exp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        /* æ’è¡Œæ¦œå€åŸŸ */
        .leaderboard-section {
            margin-bottom: 10px;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .leaderboard-rank {
            font-weight: 700;
            color: #ffd700;
            min-width: 20px;
            text-align: center;
        }

        .leaderboard-info {
            flex: 1;
            margin-left: 8px;
        }

        .leaderboard-name {
            font-weight: 600;
            color: #efeff1;
        }

        .leaderboard-level {
            font-size: 0.7rem;
            color: #b9a3e3;
        }

        .leaderboard-exp {
            font-size: 0.7rem;
            color: #4caf50;
            font-weight: 600;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        .status-dot.disconnected {
            background: #f44336;
        }

        .status-text {
            color: #b9a3e3;
        }

        /* ä¿®ç·´çµæœå½ˆçª— */
        .cultivation-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            scale: 0.8;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .cultivation-result.show {
            opacity: 1;
            scale: 1;
            pointer-events: auto;
        }

        .result-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            animation: pulse 1s ease-in-out infinite;
        }

        .result-text {
            font-size: 1rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 4px;
        }

        .result-details {
            font-size: 0.85rem;
            color: #efeff1;
            white-space: pre-line;
        }

        /* è¼‰å…¥ç‹€æ…‹ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 999;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 8px;
        }

        .loading-text {
            font-size: 0.8rem;
            color: #b9a3e3;
        }

        /* å‹•ç•« */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 350px) {
            body {
                width: 100%;
                max-width: 100%;
            }
            
            .game-panel {
                max-width: 100%;
            }
            
            .panel-content {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»è¦éŠæˆ²é¢æ¿ -->
    <div class="game-panel" id="gamePanel">
        <!-- é¢æ¿é ­éƒ¨ -->
        <div class="panel-header">
            <div class="panel-title">
                ğŸ® ä¿®ç·´éŠæˆ²
            </div>
            <button class="minimize-btn" id="minimizeBtn" title="æœ€å°åŒ–/å±•é–‹">
                â”€
            </button>
        </div>

        <!-- é¢æ¿å…§å®¹ -->
        <div class="panel-content" id="panelContent">
            <!-- ç©å®¶ç‹€æ…‹å€åŸŸ -->
            <div class="player-section">
                <div class="player-info">
                    <div class="player-name" id="playerName">è¼‰å…¥ä¸­...</div>
                    <div class="player-realm" id="playerRealm">ç…‰æ°£æœŸ ç¬¬1å±¤</div>
                    <div class="exp-bar">
                        <div class="exp-fill" id="expFill" style="width: 0%"></div>
                        <div class="exp-text" id="expText">0 / 100</div>
                    </div>
                </div>
            </div>

            <!-- æ’è¡Œæ¦œå€åŸŸ -->
            <div class="leaderboard-section">
                <div class="section-title">
                    ğŸ† æ’è¡Œæ¦œ Top 5
                </div>
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- æ’è¡Œæ¦œé …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span class="status-text" id="statusText">é€£æ¥ä¸­...</span>
            </div>
        </div>

        <!-- ä¿®ç·´çµæœå½ˆçª— -->
        <div class="cultivation-result" id="cultivationResult">
            <div class="result-icon" id="resultIcon">âš¡</div>
            <div class="result-text" id="resultText">ä¿®ç·´æˆåŠŸï¼</div>
            <div class="result-details" id="resultDetails">ç²å¾— 50 ç¶“é©—</div>
        </div>

        <!-- è¼‰å…¥è¦†è“‹å±¤ -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">è¼‰å…¥éŠæˆ²æ•¸æ“š...</div>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        class CultivationVideoComponent {
            constructor() {
                this.twitch = window.Twitch ? window.Twitch.ext : null;
                this.auth = null;
                this.context = null;
                this.playerData = null;
                this.leaderboardData = [];
                this.isConnected = false;
                this.isMinimized = false;
                
                // API è¨­å®š
                this.apiBaseUrl = 'http://172.25.241.201:3000/api';
                
                // æ›´æ–°é–“éš”
                this.updateInterval = null;
                
                this.init();
            }

            init() {
                console.log('åˆå§‹åŒ–ä¿®ç·´éŠæˆ²å½±ç‰‡å…ƒä»¶...');
                
                if (this.twitch) {
                    this.setupTwitchCallbacks();
                } else {
                    console.log('é–‹ç™¼æ¨¡å¼ï¼šæœªæª¢æ¸¬åˆ° Twitch Extensions SDK');
                    this.initDevelopmentMode();
                }
                
                this.setupEventListeners();
                this.startUpdateCycle();
            }

            setupTwitchCallbacks() {
                this.twitch.onAuthorized((auth) => {
                    console.log('ç”¨æˆ¶å·²æˆæ¬Š:', auth);
                    this.auth = auth;
                    this.loadPlayerData();
                });

                this.twitch.onContext((context, delta) => {
                    this.context = context;
                    this.handleContextChange(context);
                });

                this.twitch.onVisibilityChanged((isVisible) => {
                    if (isVisible) {
                        this.refreshData();
                    }
                });

                this.twitch.listen('broadcast', (target, contentType, message) => {
                    this.handleBroadcastMessage(message);
                });
            }

            initDevelopmentMode() {
                this.auth = {
                    token: 'dev-token',
                    userId: 'dev-user-123',
                    channelId: 'dev-channel-456'
                };
                
                setTimeout(() => {
                    this.loadPlayerData();
                }, 1000);
            }

            setupEventListeners() {
                // æœ€å°åŒ–æŒ‰éˆ•
                document.getElementById('minimizeBtn').addEventListener('click', () => {
                    this.toggleMinimize();
                });
            }

            async loadPlayerData() {
                try {
                    this.showLoading();
                    const username = this.getUsernameFromAuth();
                    
                    if (!username) {
                        console.log('ç„¡æ³•ç²å–ç”¨æˆ¶åç¨±');
                        this.setConnectionStatus(false);
                        this.hideLoading();
                        return;
                    }

                    const response = await this.apiRequest(`/players/${username}`);
                    
                    if (response.success) {
                        this.playerData = response.data;
                        this.updatePlayerUI();
                        this.setConnectionStatus(true);
                        this.loadLeaderboard();
                    } else {
                        console.error('è¼‰å…¥ç©å®¶æ•¸æ“šå¤±æ•—:', response.message);
                        this.setConnectionStatus(false);
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('è¼‰å…¥ç©å®¶æ•¸æ“šéŒ¯èª¤:', error);
                    this.setConnectionStatus(false);
                    this.hideLoading();
                }
            }

            async loadLeaderboard() {
                try {
                    const response = await this.apiRequest('/leaderboard?limit=5');
                    
                    if (response.success) {
                        this.leaderboardData = response.data;
                        this.updateLeaderboardUI();
                    } else {
                        console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', response.message);
                    }
                } catch (error) {
                    console.error('è¼‰å…¥æ’è¡Œæ¦œéŒ¯èª¤:', error);
                }
            }

            updatePlayerUI() {
                if (!this.playerData) return;

                const playerName = document.getElementById('playerName');
                const playerRealm = document.getElementById('playerRealm');
                const expFill = document.getElementById('expFill');
                const expText = document.getElementById('expText');

                if (playerName) {
                    playerName.textContent = this.playerData.username;
                }

                if (playerRealm) {
                    playerRealm.textContent = `${this.playerData.realm} ç¬¬${this.playerData.level}å±¤`;
                }

                if (expFill && expText) {
                    const expProgress = (this.playerData.experience / this.playerData.expRequired) * 100;
                    expFill.style.width = `${Math.min(expProgress, 100)}%`;
                    expText.textContent = `${this.playerData.experience} / ${this.playerData.expRequired}`;
                }
            }

            updateLeaderboardUI() {
                const leaderboardList = document.getElementById('leaderboardList');
                if (!leaderboardList) return;

                leaderboardList.innerHTML = '';

                if (this.leaderboardData.length === 0) {
                    leaderboardList.innerHTML = '<div style="text-align: center; color: #666; font-size: 0.8rem; padding: 10px;">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“š</div>';
                    return;
                }

                this.leaderboardData.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <div class="leaderboard-rank">${index + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${player.username}</div>
                            <div class="leaderboard-level">${player.realm} ${player.level}å±¤</div>
                        </div>
                        <div class="leaderboard-exp">${this.formatNumber(player.totalExperience)}</div>
                    `;
                    leaderboardList.appendChild(item);
                });
            }

            showCultivationResult(result) {
                const resultElement = document.getElementById('cultivationResult');
                const resultIcon = document.getElementById('resultIcon');
                const resultText = document.getElementById('resultText');
                const resultDetails = document.getElementById('resultDetails');

                if (result.success) {
                    resultIcon.textContent = result.critical ? 'ğŸ’¥' : 'âš¡';
                    resultText.textContent = 'ä¿®ç·´æˆåŠŸï¼';
                    resultDetails.textContent = `ç²å¾— ${result.experience} ç¶“é©—`;
                    
                    if (result.levelUp) {
                        resultDetails.textContent += `\nğŸ‰ å‡ç´šåˆ° ${result.levelUp.realm} ${result.levelUp.level}å±¤ï¼`;
                    }
                } else {
                    resultIcon.textContent = 'ğŸ’”';
                    resultText.textContent = 'ä¿®ç·´å¤±æ•—';
                    resultDetails.textContent = result.message || 'ä¿®ç·´å¤±æ•—ï¼Œè«‹é‡è©¦';
                }

                resultElement.classList.add('show');
                
                setTimeout(() => {
                    resultElement.classList.remove('show');
                }, 3000);
            }

            handleBroadcastMessage(message) {
                try {
                    const data = JSON.parse(message);
                    
                    switch (data.type) {
                        case 'cultivation_result':
                            this.showCultivationResult(data.payload);
                            break;
                        case 'player_update':
                            this.playerData = data.payload;
                            this.updatePlayerUI();
                            break;
                        case 'leaderboard_update':
                            this.leaderboardData = data.payload;
                            this.updateLeaderboardUI();
                            break;
                        default:
                            console.log('æœªçŸ¥çš„å»£æ’­è¨Šæ¯é¡å‹:', data.type);
                    }
                } catch (error) {
                    console.error('è™•ç†å»£æ’­è¨Šæ¯éŒ¯èª¤:', error);
                }
            }

            toggleMinimize() {
                const gamePanel = document.getElementById('gamePanel');
                const minimizeBtn = document.getElementById('minimizeBtn');
                
                this.isMinimized = !this.isMinimized;
                
                if (this.isMinimized) {
                    gamePanel.classList.add('minimized');
                    minimizeBtn.textContent = '+';
                } else {
                    gamePanel.classList.remove('minimized');
                    minimizeBtn.textContent = 'â”€';
                }
            }

            setConnectionStatus(connected) {
                this.isConnected = connected;
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'å·²é€£æ¥';
                } else {
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'é€£æ¥å¤±æ•—';
                }
            }

            showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }

            refreshData() {
                console.log('åˆ·æ–°æ•¸æ“š...');
                this.loadPlayerData();
            }

            startUpdateCycle() {
                // æ¯10ç§’æ›´æ–°ä¸€æ¬¡æ•¸æ“š
                this.updateInterval = setInterval(() => {
                    if (this.isConnected && !this.isMinimized) {
                        this.refreshData();
                    }
                }, 10000);
            }

            stopUpdateCycle() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }

            async apiRequest(endpoint, options = {}) {
                const url = `${this.apiBaseUrl}${endpoint}`;
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.auth ? this.auth.token : ''}`
                    },
                    timeout: 8000
                };

                try {
                    const response = await fetch(url, { ...defaultOptions, ...options });
                    return await response.json();
                } catch (error) {
                    console.error('API è«‹æ±‚å¤±æ•—:', error);
                    return { success: false, message: error.message };
                }
            }

            getUsernameFromAuth() {
                if (this.auth && this.auth.userId) {
                    return this.auth.userId;
                }
                return 'feisheng123'; // é–‹ç™¼æ¨¡å¼é»˜èªç”¨æˆ¶
            }

            formatNumber(num) {
                if (typeof num !== 'number') return '0';
                
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }

            // æ¸…ç†è³‡æº
            destroy() {
                this.stopUpdateCycle();
                
                if (this.twitch) {
                    this.twitch.unlisten('broadcast', () => {});
                }
                
                console.log('å½±ç‰‡å…ƒä»¶å·²éŠ·æ¯€');
            }
        }

        // ç•¶é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–å…ƒä»¶
        document.addEventListener('DOMContentLoaded', () => {
            window.cultivationVideoComponent = new CultivationVideoComponent();
        });

        // ç•¶é é¢å³å°‡é—œé–‰æ™‚æ¸…ç†è³‡æº
        window.addEventListener('beforeunload', () => {
            if (window.cultivationVideoComponent) {
                window.cultivationVideoComponent.destroy();
            }
        });
    </script>
</body>
</html>