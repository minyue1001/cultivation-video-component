<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修練遊戲 - 影片元件</title>
    
    <!-- Twitch Extensions SDK -->
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: transparent;
            color: #efeff1;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            font-size: clamp(14px, 2vw, 24px);
        }

        /* 主容器 */
        .game-panel {
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            border: none;
            box-shadow: none;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .game-panel.minimized {
            height: clamp(50px, 8vh, 80px);
            overflow: hidden;
        }

        /* 頭部 */
        .panel-header {
            background: rgba(145, 70, 255, 0.9);
            padding: clamp(15px, 3vh, 25px) clamp(20px, 4vw, 40px);
            border-radius: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: clamp(1.5rem, 4vw, 3rem);
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: clamp(8px, 1vw, 16px);
        }

        .minimize-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: clamp(1.2rem, 3vw, 2rem);
            cursor: pointer;
            padding: clamp(6px, 1vh, 12px) clamp(8px, 1vw, 16px);
            border-radius: 6px;
            transition: background 0.2s ease;
            font-weight: bold;
        }

        .minimize-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 內容區域 */
        .panel-content {
            padding: clamp(20px, 4vw, 50px);
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 3vh, 40px);
        }

        /* 玩家狀態區域 */
        .player-section {
            padding-bottom: clamp(15px, 3vh, 30px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.15);
            flex-shrink: 0;
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: clamp(1.8rem, 5vw, 4rem);
            font-weight: 700;
            color: #ffd700;
            margin-bottom: clamp(8px, 2vh, 16px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .player-realm {
            font-size: clamp(1.2rem, 3vw, 2.5rem);
            color: #b9a3e3;
            margin-bottom: clamp(15px, 3vh, 25px);
            font-weight: 600;
        }

        .exp-bar {
            position: relative;
            width: 100%;
            height: clamp(25px, 4vh, 50px);
            background: rgba(255, 255, 255, 0.2);
            border-radius: clamp(10px, 2vh, 25px);
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .exp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(1rem, 2.5vw, 2rem);
            font-weight: 700;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* 排行榜區域 */
        .leaderboard-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .section-title {
            font-size: clamp(1.4rem, 4vw, 3rem);
            font-weight: 700;
            color: #ffd700;
            margin-bottom: clamp(12px, 2vh, 20px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 1vw, 16px);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            flex-shrink: 0;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 1vh, 15px);
            flex: 1;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: clamp(12px, 2vh, 20px) clamp(15px, 3vw, 25px);
            background: rgba(255, 255, 255, 0.08);
            border-radius: clamp(8px, 1vh, 15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-size: clamp(1rem, 2.5vw, 2rem);
            transition: all 0.2s ease;
            min-height: clamp(50px, 6vh, 80px);
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .leaderboard-rank {
            font-weight: 700;
            color: #ffd700;
            min-width: clamp(30px, 5vw, 50px);
            text-align: center;
            font-size: clamp(1.2rem, 3vw, 2.2rem);
        }

        .leaderboard-info {
            flex: 1;
            margin-left: clamp(8px, 1.5vw, 15px);
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            color: #efeff1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-level {
            font-size: clamp(0.8rem, 2vw, 1.5rem);
            color: #b9a3e3;
            white-space: nowrap;
        }

        .leaderboard-exp {
            font-size: clamp(0.8rem, 2vw, 1.5rem);
            color: #4caf50;
            font-weight: 600;
            white-space: nowrap;
        }

        /* 狀態指示器 */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: clamp(6px, 1vw, 12px);
            padding: clamp(8px, 1vh, 15px) clamp(10px, 2vw, 20px);
            background: rgba(255, 255, 255, 0.05);
            border-radius: clamp(6px, 1vh, 12px);
            font-size: clamp(0.8rem, 2vw, 1.4rem);
            flex-shrink: 0;
        }

        .status-dot {
            width: clamp(8px, 1.5vw, 15px);
            height: clamp(8px, 1.5vw, 15px);
            border-radius: 50%;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        .status-dot.disconnected {
            background: #f44336;
        }

        .status-text {
            color: #b9a3e3;
        }

        /* 修練結果彈窗 */
        .cultivation-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: clamp(8px, 1vh, 15px);
            padding: clamp(20px, 4vw, 40px);
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            scale: 0.8;
            transition: all 0.3s ease;
            pointer-events: none;
            min-width: clamp(200px, 30vw, 400px);
            max-width: 80vw;
        }

        .cultivation-result.show {
            opacity: 1;
            scale: 1;
            pointer-events: auto;
        }

        .result-icon {
            font-size: clamp(2rem, 6vw, 4rem);
            margin-bottom: clamp(8px, 2vh, 15px);
            animation: pulse 1s ease-in-out infinite;
        }

        .result-text {
            font-size: clamp(1rem, 3vw, 2rem);
            font-weight: 700;
            color: #ffd700;
            margin-bottom: clamp(6px, 1vh, 12px);
        }

        .result-details {
            font-size: clamp(0.9rem, 2.5vw, 1.5rem);
            color: #efeff1;
            white-space: pre-line;
            font-weight: 500;
        }

        /* 載入狀態 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            z-index: 999;
        }

        .spinner {
            width: clamp(24px, 4vw, 50px);
            height: clamp(24px, 4vw, 50px);
            border: clamp(2px, 0.5vw, 4px) solid rgba(255, 255, 255, 0.3);
            border-top: clamp(2px, 0.5vw, 4px) solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: clamp(8px, 2vh, 15px);
        }

        .loading-text {
            font-size: clamp(0.9rem, 2.5vw, 1.5rem);
            color: #b9a3e3;
            font-weight: 500;
        }

        /* 動畫 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 響應式優化 */
        @media (max-width: 768px) {
            .panel-content {
                gap: clamp(15px, 2vh, 25px);
            }
            
            .leaderboard-item {
                min-height: clamp(40px, 5vh, 60px);
            }
        }
        
        @media (max-height: 600px) {
            .panel-content {
                gap: clamp(10px, 1vh, 20px);
            }
            
            .player-section {
                padding-bottom: clamp(10px, 2vh, 20px);
            }
        }
    </style>
</head>
<body>
    <!-- 主要遊戲面板 -->
    <div class="game-panel" id="gamePanel">
        <!-- 面板頭部 -->
        <div class="panel-header">
            <div class="panel-title">
                🎮 修練遊戲
            </div>
            <button class="minimize-btn" id="minimizeBtn" title="最小化/展開">
                ─
            </button>
        </div>

        <!-- 面板內容 -->
        <div class="panel-content" id="panelContent">
            <!-- 玩家狀態區域 -->
            <div class="player-section">
                <div class="player-info">
                    <div class="player-name" id="playerName">載入中...</div>
                    <div class="player-realm" id="playerRealm">煉氣期 第1層</div>
                    <div class="exp-bar">
                        <div class="exp-fill" id="expFill" style="width: 0%"></div>
                        <div class="exp-text" id="expText">0 / 100</div>
                    </div>
                </div>
            </div>

            <!-- 排行榜區域 -->
            <div class="leaderboard-section">
                <div class="section-title">
                    🏆 排行榜 Top 5
                </div>
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- 排行榜項目將由 JavaScript 動態生成 -->
                </div>
            </div>

            <!-- 狀態指示器 -->
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span class="status-text" id="statusText">連接中...</span>
            </div>
        </div>

        <!-- 修練結果彈窗 -->
        <div class="cultivation-result" id="cultivationResult">
            <div class="result-icon" id="resultIcon">⚡</div>
            <div class="result-text" id="resultText">修練成功！</div>
            <div class="result-details" id="resultDetails">獲得 50 經驗</div>
        </div>

        <!-- 載入覆蓋層 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">載入遊戲數據...</div>
        </div>
    </div>

    <!-- JavaScript 邏輯 -->
    <script>
        class CultivationVideoComponent {
            constructor() {
                this.twitch = window.Twitch ? window.Twitch.ext : null;
                this.auth = null;
                this.context = null;
                this.playerData = null;
                this.leaderboardData = [];
                this.isConnected = false;
                this.isMinimized = false;
                
                // API 設定
                this.apiBaseUrl = 'http://172.25.241.201:3000/api';
                
                // 更新間隔
                this.updateInterval = null;
                
                this.init();
            }

            init() {
                console.log('初始化修練遊戲影片元件...');
                
                if (this.twitch) {
                    this.setupTwitchCallbacks();
                } else {
                    console.log('開發模式：未檢測到 Twitch Extensions SDK');
                    this.initDevelopmentMode();
                }
                
                this.setupEventListeners();
                this.startUpdateCycle();
            }

            setupTwitchCallbacks() {
                this.twitch.onAuthorized((auth) => {
                    console.log('用戶已授權:', auth);
                    this.auth = auth;
                    this.loadPlayerData();
                });

                this.twitch.onContext((context, delta) => {
                    this.context = context;
                    this.handleContextChange(context);
                });

                this.twitch.onVisibilityChanged((isVisible) => {
                    if (isVisible) {
                        this.refreshData();
                    }
                });

                this.twitch.listen('broadcast', (target, contentType, message) => {
                    this.handleBroadcastMessage(message);
                });
            }

            initDevelopmentMode() {
                this.auth = {
                    token: 'dev-token',
                    userId: 'dev-user-123',
                    channelId: 'dev-channel-456'
                };
                
                setTimeout(() => {
                    this.loadPlayerData();
                }, 1000);
            }

            setupEventListeners() {
                // 最小化按鈕
                document.getElementById('minimizeBtn').addEventListener('click', () => {
                    this.toggleMinimize();
                });
            }

            async loadPlayerData() {
                try {
                    this.showLoading();
                    const username = this.getUsernameFromAuth();
                    
                    if (!username) {
                        console.log('無法獲取用戶名稱');
                        this.setConnectionStatus(false);
                        this.hideLoading();
                        return;
                    }

                    const response = await this.apiRequest(`/players/${username}`);
                    
                    if (response.success) {
                        this.playerData = response.data;
                        this.updatePlayerUI();
                        this.setConnectionStatus(true);
                        this.loadLeaderboard();
                    } else {
                        console.error('載入玩家數據失敗:', response.message);
                        this.setConnectionStatus(false);
                    }
                    
                    this.hideLoading();
                } catch (error) {
                    console.error('載入玩家數據錯誤:', error);
                    this.setConnectionStatus(false);
                    this.hideLoading();
                }
            }

            async loadLeaderboard() {
                try {
                    const response = await this.apiRequest('/leaderboard?limit=5');
                    
                    if (response.success) {
                        this.leaderboardData = response.data;
                        this.updateLeaderboardUI();
                    } else {
                        console.error('載入排行榜失敗:', response.message);
                    }
                } catch (error) {
                    console.error('載入排行榜錯誤:', error);
                }
            }

            updatePlayerUI() {
                if (!this.playerData) return;

                const playerName = document.getElementById('playerName');
                const playerRealm = document.getElementById('playerRealm');
                const expFill = document.getElementById('expFill');
                const expText = document.getElementById('expText');

                if (playerName) {
                    playerName.textContent = this.playerData.username;
                }

                if (playerRealm) {
                    playerRealm.textContent = `${this.playerData.realm} 第${this.playerData.level}層`;
                }

                if (expFill && expText) {
                    const expProgress = (this.playerData.experience / this.playerData.expRequired) * 100;
                    expFill.style.width = `${Math.min(expProgress, 100)}%`;
                    expText.textContent = `${this.playerData.experience} / ${this.playerData.expRequired}`;
                }
            }

            updateLeaderboardUI() {
                const leaderboardList = document.getElementById('leaderboardList');
                if (!leaderboardList) return;

                leaderboardList.innerHTML = '';

                if (this.leaderboardData.length === 0) {
                    leaderboardList.innerHTML = '<div style="text-align: center; color: #666; font-size: 0.8rem; padding: 10px;">暫無排行榜數據</div>';
                    return;
                }

                this.leaderboardData.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <div class="leaderboard-rank">${index + 1}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${player.username}</div>
                            <div class="leaderboard-level">${player.realm} ${player.level}層</div>
                        </div>
                        <div class="leaderboard-exp">${this.formatNumber(player.totalExperience)}</div>
                    `;
                    leaderboardList.appendChild(item);
                });
            }

            showCultivationResult(result) {
                const resultElement = document.getElementById('cultivationResult');
                const resultIcon = document.getElementById('resultIcon');
                const resultText = document.getElementById('resultText');
                const resultDetails = document.getElementById('resultDetails');

                if (result.success) {
                    resultIcon.textContent = result.critical ? '💥' : '⚡';
                    resultText.textContent = '修練成功！';
                    resultDetails.textContent = `獲得 ${result.experience} 經驗`;
                    
                    if (result.levelUp) {
                        resultDetails.textContent += `\n🎉 升級到 ${result.levelUp.realm} ${result.levelUp.level}層！`;
                    }
                } else {
                    resultIcon.textContent = '💔';
                    resultText.textContent = '修練失敗';
                    resultDetails.textContent = result.message || '修練失敗，請重試';
                }

                resultElement.classList.add('show');
                
                setTimeout(() => {
                    resultElement.classList.remove('show');
                }, 3000);
            }

            handleBroadcastMessage(message) {
                try {
                    const data = JSON.parse(message);
                    
                    switch (data.type) {
                        case 'cultivation_result':
                            this.showCultivationResult(data.payload);
                            break;
                        case 'player_update':
                            this.playerData = data.payload;
                            this.updatePlayerUI();
                            break;
                        case 'leaderboard_update':
                            this.leaderboardData = data.payload;
                            this.updateLeaderboardUI();
                            break;
                        default:
                            console.log('未知的廣播訊息類型:', data.type);
                    }
                } catch (error) {
                    console.error('處理廣播訊息錯誤:', error);
                }
            }

            toggleMinimize() {
                const gamePanel = document.getElementById('gamePanel');
                const minimizeBtn = document.getElementById('minimizeBtn');
                
                this.isMinimized = !this.isMinimized;
                
                if (this.isMinimized) {
                    gamePanel.classList.add('minimized');
                    minimizeBtn.textContent = '+';
                } else {
                    gamePanel.classList.remove('minimized');
                    minimizeBtn.textContent = '─';
                }
            }

            setConnectionStatus(connected) {
                this.isConnected = connected;
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = '已連接';
                } else {
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = '連接失敗';
                }
            }

            showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }

            refreshData() {
                console.log('刷新數據...');
                this.loadPlayerData();
            }

            startUpdateCycle() {
                // 每10秒更新一次數據
                this.updateInterval = setInterval(() => {
                    if (this.isConnected && !this.isMinimized) {
                        this.refreshData();
                    }
                }, 10000);
            }

            stopUpdateCycle() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }

            async apiRequest(endpoint, options = {}) {
                const url = `${this.apiBaseUrl}${endpoint}`;
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.auth ? this.auth.token : ''}`
                    },
                    timeout: 8000
                };

                try {
                    const response = await fetch(url, { ...defaultOptions, ...options });
                    return await response.json();
                } catch (error) {
                    console.error('API 請求失敗:', error);
                    return { success: false, message: error.message };
                }
            }

            getUsernameFromAuth() {
                if (this.auth && this.auth.userId) {
                    return this.auth.userId;
                }
                return 'feisheng123'; // 開發模式默認用戶
            }

            formatNumber(num) {
                if (typeof num !== 'number') return '0';
                
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }

            // 清理資源
            destroy() {
                this.stopUpdateCycle();
                
                if (this.twitch) {
                    this.twitch.unlisten('broadcast', () => {});
                }
                
                console.log('影片元件已銷毀');
            }
        }

        // 當頁面載入完成時初始化元件
        document.addEventListener('DOMContentLoaded', () => {
            window.cultivationVideoComponent = new CultivationVideoComponent();
        });

        // 當頁面即將關閉時清理資源
        window.addEventListener('beforeunload', () => {
            if (window.cultivationVideoComponent) {
                window.cultivationVideoComponent.destroy();
            }
        });
    </script>
</body>
</html>